<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Content Strategist for SERP Dominance</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Optional: Add some custom styles if needed, e.g., for score bars */
        .score-bar {
            height: 100%;
        }
         /* Style for expandable sections */
        .expandable-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .expandable-content {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb; /* gray-200 */
        }
        .expandable-header.expanded .arrow {
            transition: transform 0.2s ease-in-out;
        }
        .expandable-header.expanded .arrow {
            transform: rotate(90deg);
        }

         /* Specific styles for blueprint outline */
        .blueprint-outline {
            margin-left: 1.5rem;
            border-left: 2px solid #e5e7eb;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }
        .blueprint-outline .section {
            margin-bottom: 1rem;
        }
        .blueprint-outline .section-title {
            font-weight: 600; /* semibold */
            color: #1f2937; /* gray-900 */
        }
        .blueprint-outline .section-themes {
            font-size: 0.875rem; /* sm */
            color: #4b5563; /* gray-600 */
            margin-top: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">AI Content Strategist for SERP Dominance</h1>
            <p class="text-lg text-gray-600">Generate data-backed content strategies and blueprints using AI</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Input Keywords & Context</h2>
            <form id="keywordForm" class="space-y-6">
                <div>
                    <label for="seedKeyword" class="block text-gray-700 font-semibold mb-2">Target Keyword <span class="text-red-500">*</span></label>
                    <input type="text" id="seedKeyword" name="seed_keyword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" required placeholder="Enter your main keyword (e.g., 'best noise cancelling headphones')">
                </div>

                <div>
                    <label for="secondaryKeywords" class="block text-gray-700 font-semibold mb-2">Supporting Keywords <span class="text-gray-500 font-normal">(optional, comma-separated)</span></label>
                    <input type="text" id="secondaryKeywords" name="secondary_keywords" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Enter related keywords (e.g., 'sony wh-1000xm5 review, bose quietcomfort ultra headphones')">
                </div>

                <div>
                    <label for="industry" class="block text-gray-700 font-semibold mb-2">Industry/Niche <span class="text-gray-500 font-normal">(optional)</span></label>
                    <input type="text" id="industry" name="industry" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="E.g., 'audio electronics', 'digital marketing'">
                </div>

                <div>
                    <label for="competitorUrls" class="block text-gray-700 font-semibold mb-2">Specific Competitor URLs <span class="text-gray-500 font-normal">(optional, comma-separated)</span></label>
                    <input type="text" id="competitorUrls" name="competitor_urls" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Enter specific competitor URLs to analyze (e.g., 'https://competitor1.com/review, https://blog.competitor2.com/guide')">
                </div>

                 <div class="pt-4">
                    <button type="submit" class="w-full md:w-auto px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 transition duration-200 ease-in-out">
                        Generate Content Strategy
                    </button>
                </div>
            </form>
        </div>

        <div id="loadingState" class="hidden bg-blue-100 rounded-xl shadow-lg p-8 mb-10 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mx-auto mb-6"></div>
            <p class="text-blue-800 text-xl font-semibold">Analyzing SERPs and competitor content to generate your strategy...</p>
            <p class="text-blue-700 text-md mt-2">This may take a few minutes depending on the number of keywords and URLs.</p>
        </div>

         <div id="errorState" class="hidden bg-red-100 rounded-xl shadow-lg p-8 mb-10 text-center">
            <h3 class="text-red-800 text-xl font-semibold mb-4">Error</h3>
            <p id="errorMessage" class="text-red-700 text-md"></p>
             <p class="text-red-600 text-sm mt-4">Please check the server logs for more details or try adjusting your input.</p>
        </div>


        <div id="resultsContainer" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 mb-10">
                <h2 id="resultsTitle" class="text-3xl font-bold text-gray-800 mb-4"></h2>
                <p id="resultsDate" class="text-gray-600 mb-6"></p>

                <div class="bg-blue-50 p-6 rounded-lg border border-blue-100 mb-8">
                    <h3 class="text-blue-800 text-xl font-semibold mb-3">Executive Summary</h3>
                    <p id="insightSummary" class="text-blue-900 leading-relaxed mb-4"></p>
                     <div id="summaryTopOpportunities" class="space-y-2">
                         <h4 class="text-blue-800 font-semibold">Key Opportunities Highlight:</h4>
                         <ul id="summaryTopOpportunitiesList" class="list-disc list-inside text-blue-900"></ul>
                     </div>
                     <p id="noSummaryTopOpportunities" class="text-gray-500 italic mt-2 hidden">No top opportunities highlighted in summary.</p>
                </div>


                <div id="competitiveLandscapeSummarySection" class="bg-white rounded-xl shadow-lg p-6 mb-10 hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Competitive Content Strategy & Winning Formula</h2>
                     <div id="competitiveLandscapeSummaryContent" class="space-y-4 text-gray-800">
                         <p><strong>Dominant Content Types:</strong> <span id="compSumContentTypes">--</span></p>
                         <p><strong>Average Word Count:</strong> <span id="compSumAvgWC">--</span></p>
                         <p><strong>Common Themes & Angles:</strong> <span id="compSumThemes">--</span></p>
                         <p><strong>Common Structure Patterns:</strong> <span id="compSumStructure">--</span></p>
                         <p><strong>Most Common Media Types:</strong> <span id="compSumMedia">--</span></p>
                         <p class="leading-relaxed"><strong>Winning Formula Summary:</strong> <span id="compSumWinningFormula">--</span></p>
                     </div>
                     <p id="noCompetitiveLandscapeSummary" class="text-gray-500 italic mt-4 hidden">Competitive content analysis summary not available.</p>
                </div>


                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Keyword Analysis</h2>

                        <div id="intentDistributionSection" class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Intent Distribution</h3>
                            <div id="intentDistributionChart" class="flex items-end space-x-6 h-40">
                                </div>
                             <p id="noIntentDistribution" class="text-gray-500 italic mt-4 hidden">Intent distribution data not available.</p>
                        </div>

                         <div id="keywordOpportunitiesSection" class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Recommended Keywords</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Keyword</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Intent</th>
                                             <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Search Volume</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Keyword Difficulty</th>
                                             <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Overall Score</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Opportunity Score</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Reason/Type</th> </tr>
                                    </thead>
                                    <tbody id="keywordRecommendationsTableBody" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                </table>
                            </div>
                             <p id="noKeywordRecommendations" class="text-gray-500 italic mt-4 hidden">No keyword recommendations generated.</p>
                        </div>

                        <div id="questionKeywordsSection" class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Question-Based Keywords (People Also Ask)</h3>
                            <ul id="questionKeywordsList" class="list-disc list-inside space-y-2 text-gray-700">
                                </ul>
                             <p id="noQuestionKeywords" class="text-gray-500 italic hidden">No question keywords found in SERP analysis.</p>
                        </div>

                         <div id="keywordClustersSection">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Keyword Clusters</h3>
                            <div id="keywordClustersList" class="space-y-4">
                                </div>
                             <p id="noKeywordClusters" class="text-gray-500 italic hidden">No keyword clusters identified.</p>
                        </div>

                    </div>

                     <div class="lg:col-span-1 bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Competitive & SERP Insights</h2>

                        <div id="topCompetitorsSection" class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Top Ranking Domains</h3>
                            <ul id="topCompetitorsList" class="space-y-3 text-gray-700">
                                </ul>
                             <p id="noTopCompetitors" class="text-gray-500 italic hidden">No top competitors identified from SERP analysis.</p>
                        </div>

                         <div id="competitorContentAggregatedSummarySection" class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Analyzed Content Summary</h3>
                             <div class="space-y-4">
                                 <div class="bg-gray-100 p-4 rounded-md">
                                     <p class="text-sm text-gray-600 font-medium">URLs Successfully Analyzed</p>
                                    <p id="analyzedUrlsCount" class="text-2xl font-bold text-gray-900">--</p>
                                </div>
                                <div class="bg-gray-100 p-4 rounded-md">
                                    <p class="text-sm text-gray-600 font-medium">Average Word Count</p>
                                    <p id="avgWordCount" class="text-2xl font-bold text-gray-900">--</p>
                                </div>
                                  <div class="bg-gray-100 p-4 rounded-md">
                                    <p class="text-sm text-gray-600 font-medium">Average Readability (FKGL)</p>
                                    <p id="avgReadability" class="text-2xl font-bold text-gray-900">--</p>
                                </div>
                                <div class="bg-gray-100 p-4 rounded-md">
                                     <p class="text-sm text-gray-600 font-medium">Dominant Content Type</p>
                                    <p id="dominantContentType" class="text-2xl font-bold text-gray-900">--</p>
                                </div>
                             </div>

                             <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-3">Common Themes (Analyzed Pages)</h4>
                             <div id="commonThemesList" class="flex flex-wrap gap-2">
                                 </div>
                              <p id="noCommonThemes" class="text-gray-500 italic hidden">No common themes identified from competitor content.</p>
                        </div>

                         <div id="serpFeaturesSection">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">SERP Features Observed & Optimization</h3>
                            <ul id="serpFeaturesList" class="list-disc list-inside space-y-4 text-gray-700">
                                </ul>
                             <p id="noSerpFeatures" class="text-gray-500 italic hidden">No notable SERP features observed or insights generated.</p>
                         </div>
                    </div>
                </div>

                <div id="contentBlueprintsSection" class="bg-white rounded-xl shadow-lg p-6 mb-10 hidden">
                     <h2 class="text-2xl font-bold text-gray-800 mb-4">AI Content Blueprints</h2>
                      <div id="contentBlueprintsList" class="space-y-8">
                         </div>
                     <p id="noContentBlueprints" class="text-gray-500 italic mt-4 hidden">No content blueprints generated.</p>
                 </div>


                <div id="detailedSerpSection" class="bg-white rounded-xl shadow-lg p-6 mb-10">
                     <h2 class="text-2xl font-bold text-gray-800 mb-4">Detailed SERP Results</h2>
                     <p id="detailedSerpKeyword" class="text-gray-600 italic mb-6"></p>

                      <div id="featuredSnippetSection" class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 mb-6 hidden">
                          <h3 class="text-yellow-800 text-xl font-semibold mb-3">Featured Snippet</h3>
                          <p id="featuredSnippetContent" class="text-yellow-900 mb-3"></p>
                          <p id="featuredSnippetSource" class="text-sm text-yellow-800 italic"></p>
                      </div>

                      <div id="paaSection" class="mb-6">
                          <h3 class="text-xl font-semibold text-gray-700 mb-4">People Also Ask</h3>
                           <ul id="paaList" class="list-disc list-inside space-y-2 text-gray-700">
                               </ul>
                            <p id="noPaasList" class="text-gray-500 italic hidden">No "People Also Ask" questions found for this keyword.</p>
                      </div>

                       <div id="relatedSearchesSection" class="mb-6">
                          <h3 class="text-xl font-semibold text-gray-700 mb-4">Related Searches</h3>
                           <ul id="relatedSearchesList" class="list-disc list-inside space-y-2 text-gray-700">
                               </ul>
                           <p id="noRelatedSearchesList" class="text-gray-500 italic hidden">No "Related Searches" found for this keyword.</p>
                      </div>


                     <div id="topOrganicResultsSection">
                         <h3 class="text-xl font-semibold text-gray-700 mb-4">Top Organic Results</h3>
                          <div id="topOrganicResultsList" class="space-y-6">
                              </div>
                           <p id="noTopOrganicResults" class="text-gray-500 italic mt-4 hidden">No top organic results found for this keyword.</p>
                     </div>
                 </div>

                 <div id="detailedContentAnalysisSection" class="bg-white rounded-xl shadow-lg p-6 mb-10">
                      <h2 class="text-2xl font-bold text-gray-800 mb-6">Detailed Competitor Content Analysis</h2>
                       <div id="detailedContentAnalysisList" class="space-y-8">
                           </div>
                        <p id="noDetailedContentAnalysis" class="text-gray-500 italic hidden">No detailed competitor content analysis available (check if URLs were analyzed).</p>
                 </div>


                <div id="contentStrategySection" class="bg-white rounded-xl shadow-lg p-6 mb-10">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Content Strategy Recommendations</h2>

                    <div class="space-y-6 mb-8">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Identified Opportunities</h3>
                         <div id="contentOpportunitiesItems" class="space-y-4">
                             </div>
                         <p id="noContentOpportunities" class="text-gray-500 italic hidden">No specific content opportunities identified based on the analysis.</p>
                    </div>

                    <div class="space-y-6">
                         <h3 class="text-xl font-semibold text-gray-700 mb-4">General Recommendations</h3>
                         <div id="contentRecommendationsItems" class="space-y-4">
                             </div>
                          <p id="noContentRecommendations" class="text-gray-500 italic hidden">No general content recommendations generated.</p>
                    </div>

                </div>


                <div id="nextStepsSection" class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Recommended Next Steps</h2>
                    <div id="nextStepsList" class="space-y-6">
                        </div>
                     <p id="noNextSteps" class="text-gray-500 italic hidden">No next steps recommended.</p>
                </div>

                <div id="metadataSection" class="mt-10 text-sm text-gray-500 text-center">
                     </div>

            </div>
        </div>
    </div>

    <script>
        document.getElementById('keywordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Hide previous states and show loading
            document.getElementById('resultsContainer').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');

            // Clear previous results (Dashboard sections)
            clearDashboard();

            // Get form data
            const formData = new FormData(e.target);
            const formObject = {};

            formData.forEach((value, key) => {
                // Process comma-separated values
                if (key === 'secondary_keywords' || key === 'competitor_urls') {
                    formObject[key] = value ? value.split(',').map(item => item.trim()).filter(item => item !== '') : [];
                } else {
                    formObject[key] = value.trim();
                }
            });

            console.log('Sending data:', formObject);

            try {
                // Send request to the API
                const response = await fetch('/api/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formObject)
                });

                // Handle non-OK responses (e.g., 500 errors from Flask)
                if (!response.ok) {
                     // Attempt to parse JSON body for backend error details
                    let errorDetails = 'Unknown API error';
                    try {
                       const errorData = await response.json();
                       console.error('API Error Response Body:', errorData);
                       errorDetails = errorData.error || errorData.message || JSON.stringify(errorData);
                        // Display initialization errors if present
                       if(errorData.initialization_errors && errorData.initialization_errors.length > 0) {
                           errorDetails += "\nServer Initialization Errors:\n- " + errorData.initialization_errors.join("\n- ");
                       }

                    } catch (jsonError) {
                       // If response body isn't JSON, use status text
                       errorDetails = `API request failed with status ${response.status}: ${response.statusText}`;
                       console.error('API Error (Non-JSON response):', response.status, response.statusText);
                    }
                    throw new Error(errorDetails);
                }

                const data = await response.json();
                console.log('API Response:', data);

                // Hide loading
                document.getElementById('loadingState').classList.add('hidden');

                // Check if the response contains an error flag from the backend logic (different from HTTP error)
                if (data.error) {
                     document.getElementById('errorMessage').textContent = data.error + (data.details ? `\nDetails: ${data.details}` : '');
                     document.getElementById('errorState').classList.remove('hidden');
                      // Optionally display partial data if available for debugging
                     if (data.partial_serp_data || data.partial_competitor_data || data.partial_keyword_analysis || data.partial_insights) {
                          console.log("Partial data received:", {
                               partial_serp_data: data.partial_serp_data,
                               partial_competitor_data: data.partial_competitor_data,
                               partial_keyword_analysis: data.partial_keyword_analysis,
                               partial_insights: data.partial_insights
                          });
                           // You could add a section to display this partial data on the page for advanced users
                     }

                } else {
                    // Render the results
                    renderResults(data);

                    // Show results
                    document.getElementById('resultsContainer').classList.remove('hidden');

                    // Scroll to results
                    document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
                }


            } catch (error) {
                console.error('Fetch or API Error:', error);

                // Hide loading
                document.getElementById('loadingState').classList.add('hidden');

                // Show error state
                document.getElementById('errorMessage').textContent = error.message || 'An unexpected error occurred during the request.';
                document.getElementById('errorState').classList.remove('hidden');
            }
        });

        function clearDashboard() {
             // Clear all dynamic content areas
            document.getElementById('resultsTitle').textContent = '';
            document.getElementById('resultsDate').textContent = '';
            document.getElementById('insightSummary').textContent = '';
            document.getElementById('summaryTopOpportunitiesList').innerHTML = ''; // Clear summary top opps

            // Competitive Landscape Summary (AI) - Clear content, not hide section
            document.getElementById('compSumContentTypes').textContent = '--';
            document.getElementById('compSumAvgWC').textContent = '--';
            document.getElementById('compSumThemes').textContent = '--';
            document.getElementById('compSumStructure').textContent = '--';
            document.getElementById('compSumMedia').textContent = '--';
            document.getElementById('compSumWinningFormula').textContent = '--';


            // Removed clearing for 'topOpportunitiesList' as it seems unused or redundant


            // Clear content for other sections
            document.getElementById('intentDistributionChart').innerHTML = '';
            document.getElementById('keywordRecommendationsTableBody').innerHTML = '';
            document.getElementById('questionKeywordsList').innerHTML = '';
            document.getElementById('keywordClustersList').innerHTML = '';
            document.getElementById('topCompetitorsList').innerHTML = '';

            // Aggregated Competitor Content Summary - Clear content, not hide section
            document.getElementById('analyzedUrlsCount').textContent = '--';
            document.getElementById('avgWordCount').textContent = '--';
            document.getElementById('avgReadability').textContent = '--'; // Clear readability
            document.getElementById('dominantContentType').textContent = '--';
            document.getElementById('commonThemesList').innerHTML = '';
            document.getElementById('serpFeaturesList').innerHTML = '';

            // AI Content Blueprints - Clear content, not hide section
            document.getElementById('contentBlueprintsList').innerHTML = '';

            // Content Strategy Recommendations (Opportunities & Recommendations) - Clear content, not hide section
            document.getElementById('contentOpportunitiesItems').innerHTML = '';
            document.getElementById('contentRecommendationsItems').innerHTML = '';

            // Next Steps - Clear content, not hide section
            document.getElementById('nextStepsList').innerHTML = '';

            // Metadata - Clear content, not hide section
            document.getElementById('metadataSection').innerHTML = '';


            // Detailed SERP Results - Clear content, not hide section
            document.getElementById('detailedSerpKeyword').textContent = '';
            document.getElementById('featuredSnippetContent').textContent = '';
            document.getElementById('featuredSnippetSource').innerHTML = ''; // Clear inner HTML
            document.getElementById('paaList').innerHTML = '';
            document.getElementById('relatedSearchesList').innerHTML = '';
            document.getElementById('topOrganicResultsList').innerHTML = '';

            // Detailed Content Analysis - Clear content, not hide section
            document.getElementById('detailedContentAnalysisList').innerHTML = '';


            // Hide sections that might be empty - These should be handled by renderResults
            // Keeping these lines commented out or removed as renderResults should manage visibility
            /*
             document.getElementById('topOpportunitiesSection').classList.add('hidden');
             document.getElementById('summaryTopOpportunities').classList.add('hidden');
             document.getElementById('competitiveLandscapeSummarySection').classList.add('hidden');
             document.getElementById('intentDistributionSection').classList.add('hidden');
             document.getElementById('keywordOpportunitiesSection').classList.add('hidden');
             document.getElementById('questionKeywordsSection').classList.add('hidden');
             document.getElementById('keywordClustersSection').classList.add('hidden');
             document.getElementById('topCompetitorsSection').classList.add('hidden');
             document.getElementById('competitorContentAggregatedSummarySection').classList.add('hidden');
             document.getElementById('serpFeaturesSection').classList.add('hidden');
             document.getElementById('contentBlueprintsSection').classList.add('hidden');
             document.getElementById('detailedSerpSection').classList.add('hidden');
             document.getElementById('detailedContentAnalysisSection').classList.add('hidden');
             document.getElementById('contentStrategySection').classList.add('hidden');
             document.getElementById('nextStepsSection').classList.add('hidden');
             document.getElementById('metadataSection').classList.add('hidden');
             document.getElementById('featuredSnippetSection').classList.add('hidden');
             */


            // Hide all "No data" messages - These should be handled by renderResults
            const noDataMessages = document.querySelectorAll('[id^="no"]'); // Find all elements whose ID starts with "no"
            noDataMessages.forEach(el => el.classList.add('hidden'));
        }


        function renderResults(data) {
            console.log("Rendering data:", data); // Log the data structure


            // 1. Summary
            document.getElementById('resultsTitle').textContent = data.summary.title || 'Keyword Research Analysis';
            document.getElementById('resultsDate').textContent = `Analysis Date: ${data.summary.date || 'N/A'} • ${data.metadata.keywords_input || 0} Keywords Input • ${data.metadata.serp_keywords_processed || 0} Keywords Processed • ${data.metadata.urls_analyzed || 0} URLs Analyzed`; // Use metadata counts and add processed count

            // Executive Summary (AI)
             const insightSummary = data.summary;
             if (insightSummary && insightSummary.overall_summary) {
                 document.getElementById('insightSummary').textContent = insightSummary.overall_summary;

                 // Render key opportunities highlight from AI summary
                 const summaryTopOpportunitiesList = document.getElementById('summaryTopOpportunitiesList');
                 if (insightSummary.key_opportunities_highlight && insightSummary.key_opportunities_highlight.length > 0) {
                      summaryTopOpportunitiesList.innerHTML = insightSummary.key_opportunities_highlight.map(item => `<li>${item}</li>`).join('');
                      document.getElementById('summaryTopOpportunities').classList.remove('hidden');
                      document.getElementById('noSummaryTopOpportunities').classList.add('hidden');
                 } else {
                     summaryTopOpportunitiesList.innerHTML = '';
                     document.getElementById('summaryTopOpportunities').classList.remove('hidden'); // Keep section visible
                     document.getElementById('noSummaryTopOpportunities').classList.remove('hidden'); // Show no data message
                 }

             } else {
                 // Fallback to static summary if AI summary is missing
                 document.getElementById('insightSummary').textContent = data.summary.insight_summary || 'Summary not available.';
                 document.getElementById('summaryTopOpportunities').classList.add('hidden'); // Hide AI highlights if no AI summary
             }


            // Hide the old 'Top Opportunities' section which is now in the summary - Ensure this section is always hidden if it's not used
            document.getElementById('topOpportunitiesSection').classList.add('hidden');


            // NEW: AI Competitive Landscape Summary
            const competitiveLandscapeSummarySection = document.getElementById('competitiveLandscapeSummarySection');
            const compSumContent = data.insights.competitive_landscape_summary;
            if (compSumContent && compSumContent.winning_formula_summary) {
                 document.getElementById('compSumContentTypes').textContent = compSumContent.dominant_content_types && compSumContent.dominant_content_types.length > 0 ? compSumContent.dominant_content_types.join(', ') : '--';
                 document.getElementById('compSumAvgWC').textContent = compSumContent.average_word_count || '--';
                 document.getElementById('compSumThemes').textContent = compSumContent.common_themes_and_angles && compSumContent.common_themes_and_angles.length > 0 ? compSumContent.common_themes_and_angles.join(', ') : '--';
                 document.getElementById('compSumStructure').textContent = compSumContent.common_structure_patterns && compSumContent.common_structure_patterns.length > 0 ? compSumContent.common_structure_patterns.join(', ') : '--';
                 document.getElementById('compSumMedia').textContent = compSumContent.common_media_types && compSumContent.common_media_types.length > 0 ? compSumContent.common_media_types.join(', ') : '--';
                 document.getElementById('compSumWinningFormula').textContent = compSumContent.winning_formula_summary || '--';

                 competitiveLandscapeSummarySection.classList.remove('hidden');
                 document.getElementById('noCompetitiveLandscapeSummary').classList.add('hidden');
            } else {
                competitiveLandscapeSummarySection.classList.remove('hidden'); // Keep section visible
                document.getElementById('noCompetitiveLandscapeSummary').classList.remove('hidden'); // Show no data message
                // Clear the fields (already done in clearDashboard, but good to be safe)
                 document.getElementById('compSumContentTypes').textContent = '--';
                 document.getElementById('compSumAvgWC').textContent = '--';
                 document.getElementById('compSumThemes').textContent = '--';
                 document.getElementById('compSumStructure').textContent = '--';
                 document.getElementById('compSumMedia').textContent = '--';
                 document.getElementById('compSumWinningFormula').textContent = '--';
            }


            // 2. Keyword Analysis
            // Intent Distribution
            const intentDistributionChart = document.getElementById('intentDistributionChart');
            intentDistributionChart.innerHTML = ''; // Clear previous chart
            if (data.insights.intent_distribution && Object.keys(data.insights.intent_distribution).length > 0) {
                 Object.entries(data.insights.intent_distribution).forEach(([intent, value]) => {
                    const percentage = Math.round(value * 100);
                    const color = getIntentColor(intent); // Function to get color based on intent
                    intentDistributionChart.innerHTML += `
                        <div class="flex flex-col items-center h-full justify-end">
                            <div class="w-8 bg-gray-200 rounded-t-md relative flex-grow" style="height: ${100 - percentage}%"></div>
                            <div class="w-8 ${color} rounded-t-md relative" style="height: ${percentage}%"></div>
                            <span class="text-xs text-gray-600 mt-2 capitalize">${intent}</span>
                            <span class="text-xs font-medium text-gray-800">${percentage}%</span>
                        </div>
                    `;
                 });
                 document.getElementById('intentDistributionSection').classList.remove('hidden');
                 document.getElementById('noIntentDistribution').classList.add('hidden');
            } else {
                 intentDistributionChart.innerHTML = '';
                 document.getElementById('intentDistributionSection').classList.remove('hidden'); // Keep section visible
                 document.getElementById('noIntentDistribution').classList.remove('hidden'); // Show "No data" message
            }


            // Keyword Recommendations Table (formerly Opportunities)
            const keywordRecommendationsTableBody = document.getElementById('keywordRecommendationsTableBody'); // Updated ID
            const keywordRecommendations = data.insights.keyword_recommendations;
            if (keywordRecommendations && keywordRecommendations.length > 0) {
                keywordRecommendationsTableBody.innerHTML = keywordRecommendations.map(keyword => {
                    const intentColorClass = getIntentBadgeColor(keyword.intent); // Function to get badge color
                    const score = keyword.score_data ? keyword.score_data.score : 50;
                    const difficulty = keyword.score_data ? keyword.score_data.difficulty : '--';
                    const opportunity = keyword.score_data ? keyword.score_data.opportunity : '--';
                    const sv = keyword.score_data ? (keyword.score_data.search_volume !== null ? keyword.score_data.search_volume : '--') : '--'; // Display SV, check for null
                    const kd = keyword.score_data ? (keyword.score_data.keyword_difficulty !== null ? keyword.score_data.keyword_difficulty : '--') : '--'; // Display KD (raw value), check for null
                    const scoreColor = getScoreColor(score); // Function to get score bar color
                     const reasonType = keyword.type ? keyword.type.replace(/_/g, ' ') : 'Recommendation'; // Use type as reason label

                    return `
                        <tr>
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${keyword.keyword}</td>
                            <td class="px-6 py-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${intentColorClass}">
                                    ${keyword.intent || 'unknown'}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900">${sv}</td>
                             <td class="px-6 py-4 text-sm text-gray-900">${kd}</td>
                            <td class="px-6 py-4 text-sm text-gray-900">
                                <div class="flex items-center">
                                    <div class="w-20 h-3 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="score-bar ${scoreColor}" style="width: ${score}%"></div>
                                    </div>
                                    <span class="ml-2 text-xs text-gray-600">${Math.round(score)}</span>
                                </div>
                            </td>
                             <td class="px-6 py-4 text-sm text-gray-900">${Math.round(opportunity)}</td>
                             <td class="px-6 py-4 text-sm text-gray-600 capitalize">${reasonType}${keyword.reason ? `: ${keyword.reason}` : ''}</td>
                        </tr>
                    `;
                }).join('');
                 document.getElementById('keywordOpportunitiesSection').classList.remove('hidden'); // Keep section visible
                 document.getElementById('noKeywordRecommendations').classList.add('hidden');
            } else {
                 keywordRecommendationsTableBody.innerHTML = '';
                 document.getElementById('keywordOpportunitiesSection').classList.remove('hidden'); // Keep section visible
                 document.getElementById('noKeywordRecommendations').classList.remove('hidden'); // Show "No data" message
            }


            // Question Keywords
            const questionKeywordsList = document.getElementById('questionKeywordsList');
            if (data.keywords.questions && data.keywords.questions.length > 0) {
                questionKeywordsList.innerHTML = data.keywords.questions.map(q => `<li>${q}</li>`).join('');
                 document.getElementById('questionKeywordsSection').classList.remove('hidden');
                 document.getElementById('noQuestionKeywords').classList.add('hidden');
            } else {
                 questionKeywordsList.innerHTML = '';
                 document.getElementById('questionKeywordsSection').classList.remove('hidden'); // Keep section visible
                 document.getElementById('noQuestionKeywords').classList.remove('hidden'); // Show "No data" message
            }

            // Keyword Clusters
            const keywordClustersList = document.getElementById('keywordClustersList');
            if (data.insights.topic_clusters && data.insights.topic_clusters.length > 0) { // Use insights.topic_clusters
                 keywordClustersList.innerHTML = data.insights.topic_clusters.map(cluster => {
                    const intentColorClass = getIntentBadgeColor(cluster.intent);
                    return `
                        <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                            <h4 class="font-semibold text-gray-900 mb-2 capitalize">${cluster.topic || 'Untitled Cluster'}</h4>
                             <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${intentColorClass} mb-3">
                                    ${cluster.intent || 'unknown'} Intent
                             </span>
                            <div class="flex flex-wrap gap-2">
                                ${cluster.keywords.map(kw => `<span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">${kw}</span>`).join('')}
                            </div>
                        </div>
                    `;
                 }).join('');
                 document.getElementById('keywordClustersSection').classList.remove('hidden');
                 document.getElementById('noKeywordClusters').classList.add('hidden');
            } else {
                 keywordClustersList.innerHTML = '';
                 document.getElementById('keywordClustersSection').classList.remove('hidden'); // Keep section visible
                 document.getElementById('noKeywordClusters').classList.remove('hidden'); // Show "No data" message
            }


            // 3. Competitive & SERP Insights (Aggregated Data + AI SERP Insights)
            // Top Competitors
            const topCompetitorsList = document.getElementById('topCompetitorsList');
            // Use basic_competitive_landscape for domain distribution as the AI summary doesn't include percentages
            // Note: The backend now puts the basic domain distribution in competitive_landscape_summary if AI fails, or it's in result_renderer's logic.
            // Let's check the structure from the backend's result_renderer output.
            // Based on result_renderer.py, top_competitors is a list of {domain: str, percentage: int} directly in results.serp_insights
            const topCompetitors = data.serp_insights.top_competitors;

            if (topCompetitors && topCompetitors.length > 0) {
                 topCompetitorsList.innerHTML = topCompetitors.map(comp => `
                    <li class="flex justify-between items-center border-b border-gray-100 pb-2 last:border-b-0 last:pb-0">
                        <span class="text-gray-800">${comp.domain}</span>
                        <span class="text-sm font-medium text-gray-600">${comp.percentage}%</span>
                    </li>
                `).join('');
                 document.getElementById('topCompetitorsSection').classList.remove('hidden');
                 document.getElementById('noTopCompetitors').classList.add('hidden');
            } else {
                 topCompetitorsList.innerHTML = '';
                 document.getElementById('topCompetitorsSection').classList.remove('hidden'); // Keep section visible
                 document.getElementById('noTopCompetitors').classList.remove('hidden'); // Show "No data" message
            }

            // Analyzed Content Aggregated Summary
            const analyzedUrlsCount = data.competitor_data.analyzed_urls ? data.competitor_data.analyzed_urls.length : 0;
             document.getElementById('analyzedUrlsCount').textContent = analyzedUrlsCount;
             document.getElementById('avgWordCount').textContent = data.competitor_data.summary.avg_word_count > 0 ? `${data.competitor_data.summary.avg_word_count} words` : '--';
             document.getElementById('avgReadability').textContent = data.competitor_data.summary.avg_readability_score !== 0 && data.competitor_data.summary.avg_readability_score !== "N/A" ? data.competitor_data.summary.avg_readability_score : '--'; // Display readability
            const dominantContentType = data.competitor_data.summary.most_common_content_type && data.competitor_data.summary.most_common_content_type !== 'unknown' ? data.competitor_data.summary.most_common_content_type : '--'; // Use most_common_content_type from summary
             document.getElementById('dominantContentType').textContent = dominantContentType;

            const commonThemesList = document.getElementById('commonThemesList');
             // Use common_themes from the overall competitor_data
            if (data.competitor_data.common_themes && data.competitor_data.common_themes.length > 0) {
                 commonThemesList.innerHTML = data.competitor_data.common_themes.map(theme => `
                     <span class="px-3 py-1 bg-gray-200 text-gray-800 text-sm rounded-full">${theme}</span>
                 `).join('');
                 document.getElementById('noCommonThemes').classList.add('hidden');
            } else {
                 commonThemesList.innerHTML = '';
                 document.getElementById('noCommonThemes').classList.remove('hidden'); // Show "No data" message
            }
             document.getElementById('competitorContentAggregatedSummarySection').classList.remove('hidden'); // Always show summary section


            // SERP Features & Optimization (AI)
            const serpFeaturesList = document.getElementById('serpFeaturesList');
            // Use serp_feature_insights from insights
            const serpFeatureInsights = data.insights.serp_feature_insights;
            if (serpFeatureInsights && serpFeatureInsights.length > 0) { // Use insights.serp_feature_insights (AI)
                 serpFeaturesList.innerHTML = serpFeatureInsights.map(feature => `
                     <li>
                         <span class="font-medium">${feature.feature.replace(/_/g, ' ')}:</span> ${feature.description || ''}
                          ${feature.strategy ? `<p class="text-sm text-gray-600 italic mt-1">Strategy: ${feature.strategy}</p>` : ''}
                     </li>
                 `).join('');
                 document.getElementById('serpFeaturesSection').classList.remove('hidden');
                 document.getElementById('noSerpFeatures').classList.add('hidden');
            } else {
                 serpFeaturesList.innerHTML = '';
                 document.getElementById('serpFeaturesSection').classList.remove('hidden'); // Keep section visible
                 document.getElementById('noSerpFeatures').classList.remove('hidden'); // Show "No data" message
            }

            // NEW: AI Content Blueprints Section
             const contentBlueprintsSection = document.getElementById('contentBlueprintsSection');
             const contentBlueprintsList = document.getElementById('contentBlueprintsList');
             const blueprints = data.insights.content_blueprints;

             if (blueprints && Object.keys(blueprints).length > 0) {
                  contentBlueprintsSection.classList.remove('hidden');
                  contentBlueprintsList.innerHTML = ''; // Clear previous blueprints

                  for (const keyword in blueprints) {
                       const blueprint = blueprints[keyword];
                       if (blueprint) {
                            contentBlueprintsList.innerHTML += `
                               <div class="bg-white rounded-lg shadow-md p-6 mb-6 last:mb-0">
                                   <div class="expandable-header text-lg font-semibold text-gray-800 mb-4" onclick="toggleExpandable(this)">
                                       <span class="arrow inline-block mr-2">></span> Blueprint for: "${keyword}"
                                   </div>
                                   <div class="expandable-content">
                                        <p class="text-gray-700 mb-2"><strong>Recommended Type:</strong> ${blueprint.recommended_content_type || 'N/A'}</p>
                                        <p class="text-gray-700 mb-2"><strong>Target Word Count:</strong> ${blueprint.recommended_word_count_range || 'N/A'}</p>
                                         <p class="text-gray-700 mb-2"><strong>Overall Themes:</strong> ${blueprint.key_themes_overall && blueprint.key_themes_overall.length > 0 ? blueprint.key_themes_overall.join(', ') : 'N/A'}</p>
                                         <p class="text-gray-700 mb-2"><strong>Unique Angle Ideas:</strong> ${blueprint.unique_angle_ideas && blueprint.unique_angle_ideas.length > 0 ? blueprint.unique_angle_ideas.join('; ') : 'N/A'}</p>
                                         <p class="text-gray-700 mb-4"><strong>Target PAA Questions:</strong> ${blueprint.target_paa_questions && blueprint.target_paa_questions.length > 0 ? blueprint.target_paa_questions.join('; ') : 'None specified'}</p>

                                        <h4 class="font-semibold text-gray-800 mb-3">Suggested Outline:</h4>
                                        <div id="blueprintOutline-${keyword}" class="blueprint-outline-container">
                                            ${renderBlueprintOutline(blueprint.suggested_outline)}
                                        </div>
                                   </div>
                               </div>
                            `;
                       }
                  }
                  document.getElementById('noContentBlueprints').classList.add('hidden');

             } else {
                 contentBlueprintsSection.classList.remove('hidden'); // Keep section visible
                 document.getElementById('noContentBlueprints').classList.remove('hidden'); // Show no data message
                 contentBlueprintsList.innerHTML = ''; // Clear list
             }


            // Detailed SERP Results (per keyword, uses data from SerpCollector)
            const detailedSerpSection = document.getElementById('detailedSerpSection');
            const detailedSerpKeywordElement = document.getElementById('detailedSerpKeyword');
            const featuredSnippetSection = document.getElementById('featuredSnippetSection');
            const featuredSnippetContentElement = document.getElementById('featuredSnippetContent');
            const featuredSnippetSourceElement = document.getElementById('featuredSnippetSource');
            const paaList = document.getElementById('paaList');
            const relatedSearchesList = document.getElementById('relatedSearchesList');
            const topOrganicResultsList = document.getElementById('topOrganicResultsList');

             // For detailed SERP, typically show for the seed keyword or the first keyword analyzed
             // Use the actual seed keyword from the input data
             const primaryKeywordForDetailedSerp = data.metadata.seed_keyword || (data.keywords.analyzed && data.keywords.analyzed.length > 0 ? data.keywords.analyzed[0].keyword : null);

             // Ensure data structures exist before accessing
             const detailedSerpData = primaryKeywordForDetailedSerp && data.serp_data && data.serp_data.serp_data ? data.serp_data.serp_data[primaryKeywordForDetailedSerp] : null;
             const detailedSerpFeatures = primaryKeywordForDetailedSerp && data.serp_data && data.serp_data.features ? data.serp_data.features[primaryKeywordForDetailedSerp] : null;
             const detailedSerpPaa = primaryKeywordForDetailedSerp && data.serp_data && data.serp_data.paa_questions ? data.serp_data.paa_questions[primaryKeywordForDetailedSerp] : null;
             const detailedSerpRelated = primaryKeywordForDetailedSerp && data.serp_data && data.serp_data.related_searches ? data.serp_data.related_searches[primaryKeywordForDetailedSerp] : null;
             // Featured snippet might be top-level or per keyword depending on SerpAPI response structure and backend processing
             // Based on SerpCollector, it might be a top-level 'featured_snippet' or within the keyword's data if using google_keywords engine.
             // Let's check the top-level first, as SerpCollector seems to store it there if present.
             const detailedFeaturedSnippet = data.serp_data && data.serp_data.featured_snippet ? data.serp_data.featured_snippet : null;


            if (primaryKeywordForDetailedSerp && (detailedSerpData || detailedSerpPaa || detailedSerpRelated || detailedFeaturedSnippet)) {
                detailedSerpSection.classList.remove('hidden');
                detailedSerpKeywordElement.textContent = `For Keyword: "${primaryKeywordForDetailedSerp}"`;

                 // Featured Snippet
                 if (detailedFeaturedSnippet) { // Use the directly extracted featured snippet data
                     featuredSnippetSection.classList.remove('hidden');
                     featuredSnippetContentElement.textContent = detailedFeaturedSnippet.snippet || 'N/A'; // Use snippet from SerpAPI data
                     featuredSnippetSourceElement.innerHTML = `Source: <a href="${detailedFeaturedSnippet.link}" target="_blank" class="text-blue-600 hover:underline">${detailedFeaturedSnippet.title || detailedFeaturedSnippet.link || 'N/A'}</a>`;
                 } else {
                     featuredSnippetSection.classList.add('hidden');
                 }

                // PAA
                if (detailedSerpPaa && detailedSerpPaa.length > 0) {
                    paaList.innerHTML = detailedSerpPaa.map(q => `<li>${q}</li>`).join('');
                    document.getElementById('paaSection').classList.remove('hidden');
                    document.getElementById('noPaasList').classList.add('hidden');
                } else {
                    paaList.innerHTML = '';
                     document.getElementById('paaSection').classList.remove('hidden'); // Keep section
                     document.getElementById('noPaasList').classList.remove('hidden'); // Show "No data" message
                }

                 // Related Searches
                if (detailedSerpRelated && detailedSerpRelated.length > 0) {
                    relatedSearchesList.innerHTML = detailedSerpRelated.map(rs => `<li>${rs}</li>`).join('');
                    document.getElementById('relatedSearchesSection').classList.remove('hidden');
                    document.getElementById('noRelatedSearchesList').classList.add('hidden');
                } else {
                    relatedSearchesList.innerHTML = '';
                     document.getElementById('relatedSearchesSection').classList.remove('hidden'); // Keep section
                     document.getElementById('noRelatedSearchesList').classList.remove('hidden'); // Show "No data" message
                }

                // Top Organic Results
                 if (detailedSerpData && detailedSerpData.length > 0) {
                     topOrganicResultsList.innerHTML = detailedSerpData.map(res => `
                         <div class="border p-4 rounded-md bg-gray-50">
                             <h4 class="text-lg font-semibold text-blue-800 hover:underline"><a href="${res.link}" target="_blank">${res.title || res.link}</a></h4> <p class="text-green-700 text-sm">${res.link}</p> <p class="text-gray-800 text-sm mt-1">${res.snippet || 'No description available.'}</p> </div>
                     `).join('');
                     document.getElementById('topOrganicResultsSection').classList.remove('hidden');
                     document.getElementById('noTopOrganicResults').classList.add('hidden');
                 } else {
                     topOrganicResultsList.innerHTML = '';
                     document.getElementById('topOrganicResultsSection').classList.remove('hidden'); // Keep section
                     document.getElementById('noTopOrganicResults').classList.remove('hidden'); // Show "No data" message
                 }


            } else {
                detailedSerpSection.classList.add('hidden'); // Hide entire section if no detailed SERP data
            }


            // Detailed Competitor Content Analysis (per URL, uses detailed_content_analysis)
             const detailedContentAnalysisSection = document.getElementById('detailedContentAnalysisSection');
             const detailedContentAnalysisList = document.getElementById('detailedContentAnalysisList');

             const detailedAnalysis = data.competitor_data.content_analysis; // Use detailed analysis data
             const analyzedUrlsList = data.competitor_data.analyzed_urls; // List of successfully analyzed URLs

             if (analyzedUrlsList && analyzedUrlsList.length > 0 && detailedAnalysis) {
                  detailedContentAnalysisSection.classList.remove('hidden');
                  detailedContentAnalysisList.innerHTML = analyzedUrlsList.map(url => {
                       const analysis = detailedAnalysis[url]; // Get analysis data for the URL
                       if (!analysis) return ''; // Skip if analysis data is missing for some reason

                       const themes = analysis.key_themes && analysis.key_themes.length > 0 ? analysis.key_themes.map(t => `<span class="px-2 py-0.5 bg-gray-200 text-gray-800 text-xs rounded-full">${t}</span>`).join(' ') : 'N/A';
                       const mediaTypes = analysis.media_types && analysis.media_types.length > 0 ? analysis.media_types.join(', ') : 'N/A';
                       const headings = analysis.headings && analysis.headings.length > 0 ? analysis.headings.map(h => `<li>${h || 'Untitled Heading'}</li>`).join('') : '<li>N/A</li>'; // Use placeholder if heading text is empty
                       const readability = analysis.readability_score !== undefined && analysis.readability_score !== null ? analysis.readability_score : 'N/A';
                       const mainPoints = analysis.main_points_summary || 'N/A'; // New field
                       const ctas = analysis.calls_to_action && analysis.calls_to_action.length > 0 ? analysis.calls_to_action.join('; ') : 'N/A'; // New field


                       return `
                           <div class="bg-white rounded-lg shadow-md p-6">
                               <div class="expandable-header text-lg font-semibold text-gray-800 mb-4" onclick="toggleExpandable(this)">
                                   <span class="arrow inline-block mr-2">></span> Analysis for: <a href="${url}" target="_blank" class="text-blue-600 hover:underline ml-2">${analysis.title || url}</a>
                               </div>
                               <div class="expandable-content">
                                   <p class="text-gray-700 mb-2"><strong>URL:</strong> <a href="${url}" target="_blank" class="text-blue-600 hover:underline">${url}</a></p>
                                   <p class="text-gray-700 mb-2"><strong>H1:</strong> ${analysis.h1 || 'N/A'}</p>
                                   <p class="text-gray-700 mb-2"><strong>Word Count:</strong> ${analysis.word_count > 0 ? analysis.word_count : 'N/A'}</p>
                                   <p class="text-gray-700 mb-2"><strong>Readability (FKGL):</strong> ${readability}</p> <p class="text-gray-700 mb-2"><strong>Content Type:</strong> ${analysis.content_type || 'N/A'}</p>
                                   <p class="text-gray-700 mb-2"><strong>Publication Date:</strong> ${analysis.publication_date || 'N/A'}</p>
                                   <p class="text-gray-700 mb-2"><strong>Media Types:</strong> ${mediaTypes}</p>
                                   <p class="text-gray-700 mb-2"><strong>Main Points Summary:</strong> ${mainPoints}</p> <p class="text-gray-700 mb-2"><strong>Calls to Action (CTAs):</strong> ${ctas}</p> <div class="mt-4">
                                       <h4 class="font-semibold text-gray-800 mb-2">Key Themes:</h4>
                                       <div class="flex flex-wrap gap-2">${themes}</div>
                                   </div>

                                    <div class="mt-4">
                                       <h4 class="font-semibold text-gray-800 mb-2">Subheadings (H2/H3):</h4>
                                       <ul class="list-disc list-inside text-gray-700 space-y-1">${headings}</ul>
                                   </div>
                               </div>
                           </div>
                       `;
                  }).join('');
                   document.getElementById('noDetailedContentAnalysis').classList.add('hidden');
             } else {
                 detailedContentAnalysisSection.classList.add('hidden'); // Hide the whole section
                  document.getElementById('noDetailedContentAnalysis').classList.remove('hidden'); // Show "No data" message (in case the section gets shown but has no data)
             }


            // 4. Content Strategy Recommendations (AI and Rule-based)
             const contentStrategySection = document.getElementById('contentStrategySection');
             // Check if either list has content before showing the section
             const contentOpportunities = data.insights.content_opportunities;
             const contentRecommendations = data.insights.keyword_recommendations; // Using keyword_recommendations here as per previous structure, though name is 'Recommendations'

             if ((contentOpportunities && contentOpportunities.length > 0) || (contentRecommendations && contentRecommendations.length > 0)) {
                 contentStrategySection.classList.remove('hidden'); // Ensure section is visible

                 // Identified Opportunities (AI and basic)
                 const contentOpportunitiesItems = document.getElementById('contentOpportunitiesItems');
                 if (contentOpportunities && contentOpportunities.length > 0) {
                     contentOpportunitiesItems.innerHTML = contentOpportunities.map(opportunity => `
                         <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                             <span class="inline-block px-2 py-1 text-xs font-medium rounded-full mb-2 ${
                                 // Use more specific type mapping for coloring opportunities
                                 opportunity.type === 'question_content' ? 'bg-blue-100 text-blue-800' :
                                 opportunity.type === 'content_type_gap' ? 'bg-green-100 text-green-800' :
                                 opportunity.type === 'intent_gap' ? 'bg-purple-100 text-purple-800' :
                                 opportunity.type === 'serp_feature_opportunity' ? 'bg-yellow-100 text-yellow-800' :
                                 opportunity.type === 'freshness_opportunity' ? 'bg-teal-100 text-teal-800' :
                                 opportunity.type === 'depth_opportunity' ? 'bg-indigo-100 text-indigo-800' :
                                  opportunity.type === 'media_opportunity' ? 'bg-pink-100 text-pink-800' :
                                  opportunity.type === 'high_score' ? 'bg-orange-100 text-orange-800' : // If high_score appears here
                                 'bg-gray-100 text-gray-800' // Default color
                             }">${opportunity.type ? opportunity.type.replace(/_/g, ' ') : 'opportunity'}</span>
                             <h4 class="font-semibold text-gray-900 mb-1">${opportunity.title || 'Untitled Opportunity'}</h4>
                             <p class="text-sm text-gray-600">${opportunity.description || 'No description provided.'}</p>
                         </div>
                     `).join('');
                      document.getElementById('noContentOpportunities').classList.add('hidden');
                 } else {
                      contentOpportunitiesItems.innerHTML = '';
                      document.getElementById('noContentOpportunities').classList.remove('hidden');
                 }

                 // General Recommendations (AI and basic)
                 const contentRecommendationsItems = document.getElementById('contentRecommendationsItems');
                 if (contentRecommendations && contentRecommendations.length > 0) {
                      contentRecommendationsItems.innerHTML = contentRecommendations.map(recommendation => {
                            // Use type mapping for coloring recommendations
                          const recColorClass =
                                 recommendation.type === 'content_length' ? 'bg-blue-100 text-blue-800' :
                                 recommendation.type === 'content_format' ? 'bg-teal-100 text-teal-800' :
                                 recommendation.type === 'intent_targeting' ? 'bg-indigo-100 text-indigo-800' :
                                 recommendation.type === 'serp_feature' ? 'bg-pink-100 text-pink-800' :
                                 recommendation.type === 'high_score' ? 'bg-orange-100 text-orange-800' : // If high_score appears here
                                 recommendation.type === 'question' ? 'bg-green-100 text-green-800' : // Question keyword
                                  recommendation.type === 'related_search' ? 'bg-yellow-100 text-yellow-800' : // Related search
                                 'bg-gray-100 text-gray-800'; // Default color

                          const scoreText = recommendation.score_data && recommendation.score_data.score !== undefined ? ` (Score: ${Math.round(recommendation.score_data.score)})` : '';

                          return `
                              <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                                  <span class="inline-block px-2 py-1 text-xs font-medium rounded-full mb-2 ${recColorClass}">
                                      ${recommendation.type ? recommendation.type.replace(/_/g, ' ') : 'recommendation'}
                                  </span>
                                  <h4 class="font-semibold text-gray-900 mb-1">${recommendation.keyword || recommendation.title || 'Untitled Recommendation'}</h4> <p class="text-sm text-gray-600">${recommendation.reason || recommendation.description || 'No description provided.'}${scoreText}</p> </div>
                          `;
                      }).join('');
                       document.getElementById('noContentRecommendations').classList.add('hidden');
                 } else {
                      contentRecommendationsItems.innerHTML = '';
                       document.getElementById('noContentRecommendations').classList.remove('hidden');
                 }

             } else {
                 contentStrategySection.classList.add('hidden'); // Hide the whole content strategy section if both lists are empty
             }


            // 5. Next Steps
            const nextStepsList = document.getElementById('nextStepsList');
             // Note: Next Steps are generated by ResultRenderer, use that data
            if (data.next_steps && data.next_steps.length > 0) {
                nextStepsList.innerHTML = data.next_steps.map(step => `
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-lg">
                            ${step.step}
                        </div>
                        <div class="ml-4 flex-grow">
                            <h3 class="text-lg font-semibold text-gray-900 mb-1">${step.title}</h3>
                            <p class="text-gray-700">${step.description}</p>
                        </div>
                    </div>
                `).join('');
                 document.getElementById('nextStepsSection').classList.remove('hidden');
                 document.getElementById('noNextSteps').classList.add('hidden');
            } else {
                 nextStepsList.innerHTML = '';
                 document.getElementById('nextStepsSection').classList.remove('hidden'); // Keep section visible
                 document.getElementById('noNextSteps').classList.remove('hidden'); // Show "No data" message
            }


            // 6. Metadata
            const metadataSection = document.getElementById('metadataSection');
            if (data.metadata) {
                 metadataSection.innerHTML = `
                     <p>Processed in ${data.metadata.processing_time_seconds ? data.metadata.processing_time_seconds.toFixed(2) : '--'} seconds.
                     Keywords Input: ${data.metadata.keywords_input || 0},
                     SERP Keywords Processed: ${data.metadata.serp_keywords_processed || 0},
                     URLs Analyzed: ${data.metadata.urls_analyzed || 0}.
                     Version: ${data.metadata.version || 'N/A'}.
                     Start Time: ${data.metadata.start_time || 'N/A'},
                     End Time: ${data.metadata.end_time || 'N/A'}.
                     </p>
                     ${data.metadata.initialization_errors && data.metadata.initialization_errors.length > 0 ?
                        `<p class="text-red-600 mt-2">Initialization Warnings/Errors: ${data.metadata.initialization_errors.join('; ')}</p>` : ''}
                 `;
                 document.getElementById('metadataSection').classList.remove('hidden');
            } else {
                 document.getElementById('metadataSection').classList.add('hidden');
            }
        }

        // Helper function to get color class for intent distribution bars
        function getIntentColor(intent) {
            switch (intent ? intent.toLowerCase() : '') {
                case 'informational': return 'bg-blue-500';
                case 'commercial': return 'bg-green-500';
                case 'transactional': return 'bg-purple-500';
                case 'navigational': return 'bg-yellow-500';
                case 'unknown': return 'bg-gray-500';
                default: return 'bg-gray-500';
            }
        }

         // Helper function to get color class for intent badges
        function getIntentBadgeColor(intent) {
            switch (intent ? intent.toLowerCase() : '') {
                case 'informational': return 'bg-blue-100 text-blue-800';
                case 'commercial': return 'bg-green-100 text-green-800';
                case 'transactional': return 'bg-purple-100 text-purple-800';
                case 'navigational': return 'bg-yellow-100 text-yellow-800';
                case 'unknown': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

         // Helper function to get color for score bars
         function getScoreColor(score) {
             if (score === undefined || score === null) return 'bg-gray-500';
             const s = Math.round(score); // Ensure score is an integer 0-100
             if (s >= 80) return 'bg-green-500';
             if (s >= 60) return 'bg-yellow-500';
             if (s >= 40) return 'bg-orange-500';
             return 'bg-red-500';
         }

         // Helper function to render the nested blueprint outline
         function renderBlueprintOutline(sections) {
             if (!sections || sections.length === 0) return 'N/A';

             let html = '<div class="blueprint-outline">';
             sections.forEach(section => {
                 html += `
                     <div class="section">
                         <div class="section-title">H${section.level}: ${section.title || 'Untitled Section'}</div>
                         ${section.themes_to_cover && section.themes_to_cover.length > 0 ?
                            `<div class="section-themes">Themes: ${section.themes_to_cover.join(', ')}</div>` : ''}
                          ${section.notes ? `<div class="text-sm text-gray-600 italic mt-1">Notes: ${section.notes}</div>` : ''}
                         ${renderBlueprintOutline(section.sub_sections)} </div>
                 `;
             });
             html += '</div>';
             return html;
         }


         // --- Interactivity ---
         function toggleExpandable(headerElement) {
             headerElement.classList.toggle('expanded');
             const content = headerElement.nextElementSibling;
             if (content.style.display === 'block') {
                 content.style.display = 'none';
             } else {
                 content.style.display = 'block';
             }
         }


         // Make the toggleExpandable function globally accessible (needed because it's called from inline HTML)
         window.toggleExpandable = toggleExpandable;
         // Make the renderBlueprintOutline function accessible globally for the initial call
          window.renderBlueprintOutline = renderBlueprintOutline;


    </script>
</body>
</html>
